import{d as e,i as t,u as a,r as l,e as n,f as s}from"./index-3a23732c.js";import"./vue-echarts-85a407f1.js";import{a as o,b as i}from"./element-plus-f16307a8.js";import"./store-96e17a43.js";import{u as r}from"./index-538f59ff.js";import{d,p,e as u,R as c,o as m,c as v,b as f,y as b,Y as h,a as y,J as g,M as x,K as k,N as _,I as w,al as j,ak as C,q as I,V as S,F as N}from"./@vue.runtime-core-4f5b9f62.js";import{e as V,u as W,h as z}from"./@vue.reactivity-bec702f3.js";import{_ as q}from"./_plugin-vue_export-helper-c4cb8a60.js";import{v as M,w as T}from"./@vue.runtime-dom-c19fd55a.js";import{Q as U,R as $,E as A}from"./@element-plus.icons-vue-c0c6c02f.js";import{j as B}from"./lodash-es-a085e596.js";import{o as F,L as R}from"./@vue.shared-5670d8a7.js";import"./axios-966d6f38.js";import"./nprogress-6d1393d1.js";import"./vue-router-18ffceba.js";import"./pinia-dbeeb1e2.js";import"./vue-demi-5b9a0fa5.js";import"./@vueuse.core-d0bf94bd.js";import"./@vueuse.shared-3f1de09b.js";import"./vue-2b98d5da.js";import"./mockjs-93ca2bc8.js";import"./mitt-dab1f1cb.js";import"./@popperjs.core-040feab9.js";import"./@ctrl.tinycolor-84ad98d6.js";import"./dayjs-dd470533.js";import"./async-validator-efc2d198.js";import"./memoize-one-99e54574.js";import"./escape-html-4bbaf1e1.js";import"./normalize-wheel-es-da779ce4.js";import"./@floating-ui.dom-9d85c32a.js";import"./@floating-ui.core-c56fb7e8.js";import"./resize-detector-94afada7.js";import"./echarts-33de40b3.js";import"./tslib-ed971494.js";import"./zrender-d158d5d4.js";const E={class:"dept-select"},L=d({name:"dept-select"}),K=q(d({...L,props:{modelValue:[Array,Number,String],multiple:Boolean,checkStrictly:{type:Boolean,default:!0}},emits:["update:modelValue","change"],setup(t,{emit:a}){const l=t,{service:n}=r(),s=V(),i=V();function d(e){l.multiple||a("update:modelValue",e)}function b(e,{checkedKeys:t}){l.multiple&&a("update:modelValue",t)}return p((()=>l.modelValue),(e=>{s.value=e}),{immediate:!0}),u((()=>{n.base.sys.department.list().then((t=>{i.value=e(t)})).catch((e=>{i.value=[],o.error(e.message)}))})),(e,a)=>{const l=c("el-tree-select");return m(),v("div",E,[f(l,{modelValue:s.value,"onUpdate:modelValue":a[0]||(a[0]=e=>s.value=e),"node-key":"id",data:i.value,props:{label:"name",value:"id",children:"children"},multiple:t.multiple,"check-strictly":t.checkStrictly,"show-checkbox":t.multiple,"default-expand-all":"",onChange:d,onCheck:b},null,8,["modelValue","data","multiple","check-strictly","show-checkbox"])])}}}),[["__scopeId","data-v-6be59c9b"]]),O={class:"dept-move"},G=d({name:"dept-move"}),J=d({...G,setup(e,{expose:a}){const{service:l}=r(),n=t.exports.useForm(),s=t.exports.useCrud();return a({open:async function(e){var t;null==(t=n.value)||t.open({title:"部门转移",width:"600px",props:{labelWidth:"80px"},items:[{label:"选择部门",prop:"departmentId",component:{vm:K}}],on:{submit(t,{done:a,close:n}){if(!t.departmentId)return o.warning("請選擇部门"),a();i.confirm("是否转移部门？","提示",{type:"warning"}).then((()=>{l.base.sys.user.move({...t,userIds:e}).then((()=>{var e;o.success("转移成功"),null==(e=s.value)||e.refresh(),n()})).catch((e=>{o.error(e.message),a()}))})).catch((()=>null))}}})}}),(e,t)=>{const a=c("cl-form");return m(),v("div",O,[f(a,{ref_key:"Form",ref:n},null,512)])}}}),Q={class:"dept-tree"},Y={class:"dept-tree__header"},D=(e=>(j("data-v-87c6d1b5"),e=e(),C(),e))((()=>y("div",null,"組織架構",-1))),H={class:"dept-tree__op"},P={class:"no"},X=["onContextmenu"],Z={class:"dept-tree__node"},ee=["onClick"],te=["onClick"],ae=d({name:"dept-tree"}),le=q(d({...ae,props:{drag:{type:Boolean,default:!0},level:{type:Number,default:99}},emits:["list-change","row-click","user-add"],setup(s,{emit:d}){const p=s,{service:j}=r(),{app:C}=a(),I=V([]),S=V(),N=V(!1),z=V(!1),q=t.exports.useForm(),E=b("viewGroup");function L({data:e}){return e.parentId}function K(e,t){return t.data.parentId}async function O(){N.value=!0,z.value=!1,await j.base.sys.department.list().then((t=>{I.value=e(t),S.value||(S.value=I.value[0]),G(S.value)})),N.value=!1}function G(e){if(e){const t=e.children?l(e.children).map((e=>e.id)):[];t.unshift(e.id),S.value=e,E.checkExpand(!1),d("row-click",{item:e,ids:t})}}function J(e){var t;const a=e.id?"update":"add";null==(t=q.value)||t.open({title:"編輯部門",width:"550px",props:{labelWidth:"100px"},items:[{label:"部門名稱",prop:"name",component:{name:"el-input"},required:!0},{label:"上級部門",prop:"parentName",component:{name:"el-input",props:{disabled:!0}}},{label:"排序",prop:"orderNum",component:{name:"el-input-number",props:{"controls-position":"right",min:0,max:100}}}],form:e,on:{submit(t,{done:l,close:n}){j.base.sys.department[a]({id:e.id,parentId:e.parentId,name:t.name,orderNum:t.orderNum}).then((()=>{o.success(`新增部門 “${t.name}” 成功`),n(),O()})).catch((e=>{o.error(e.message),l()}))}}})}function ae(e){e?i.confirm("部門架構已發生改變，是否保存？","提示",{type:"warning"}).then((async()=>{const e=[];!function t(a,l){a.forEach((a=>{a.parentId=l,e.push(a),a.children&&B(a.children)&&t(a.children,a.id)}))}(I.value,null),await j.base.sys.department.order(e.map(((e,t)=>({id:e.id,parentId:e.parentId,orderNum:t})))).then((()=>{o.success("更新排序成功")})).catch((e=>{o.error(e.message)})),O(),z.value=!1})).catch((()=>null)):O()}function le(e,a,l){a||(a=I.value[0]||{});const s=j.base.sys.department.permission;t.exports.ContextMenu.open(e,{list:[{label:"新增",hidden:l&&l.level>=p.level||!n(s.add),callback(e){J({name:"",parentName:a.name,parentId:a.id}),e()}},{label:"編輯",hidden:!n(s.update),callback(e){J(a),e()}},{label:"刪除",hidden:!a.parentId||!n(s.delete),callback(e){!function(e){async function t(t){await j.base.sys.department.delete({ids:[e.id],deleteUser:t}).then((()=>{e.id==S.value.id&&(S.value=null),t?o.success("刪除成功"):i.confirm(`“${e.name}” 部門的用戶已成功轉移到 “${e.parentName}” 部門。`,"刪除成功")})),O()}i.confirm(`該操作會刪除 “${e.name}” 部門的所有用戶，是否確認？`,"提示",{type:"warning",confirmButtonText:"直接刪除",cancelButtonText:"保留用戶",distinguishCancelAndClose:!0}).then((()=>{t(!0)})).catch((e=>{"cancel"==e&&t(!1)}))}(a),e()}},{label:"新增成員",hidden:!n(s.add),callback(e){d("user-add",a),e()}}]})}return u((function(){O()})),(e,t)=>{const a=c("el-icon"),l=c("el-tooltip"),n=c("el-button"),o=c("el-tree"),i=c("el-scrollbar"),r=c("cl-form"),d=h("loading");return m(),v("div",Q,[y("div",Y,[D,y("ul",H,[y("li",{onClick:t[0]||(t[0]=e=>O())},[f(l,{content:"刷新"},{default:g((()=>[f(a,null,{default:g((()=>[f(W(U))])),_:1})])),_:1})]),s.drag&&!W(C).browser.isMini?(m(),v("li",{key:0,onClick:t[1]||(t[1]=e=>z.value=!0)},[f(l,{content:"拖動排序"},{default:g((()=>[f(a,null,{default:g((()=>[f(W($))])),_:1})])),_:1})])):x("",!0),k(y("li",P,[f(n,{onClick:t[2]||(t[2]=e=>ae(!0)),size:"small"},{default:g((()=>[_("保存")])),_:1}),f(n,{onClick:t[3]||(t[3]=e=>ae(!1)),size:"small"},{default:g((()=>[_("取消")])),_:1})],512),[[M,z.value]])])]),y("div",{class:"dept-tree__container",onContextmenu:T(le,["stop","prevent"])},[f(i,null,{default:g((()=>[k((m(),w(o,{"node-key":"id","default-expand-all":"",data:I.value,props:{label:"name"},draggable:z.value,"allow-drag":L,"allow-drop":K,"expand-on-click-node":!1,onNodeContextmenu:le},{default:g((({node:e,data:t})=>{var l;return[y("div",Z,[y("span",{class:F(["dept-tree__node-label",{"is-active":t.id==(null==(l=S.value)?void 0:l.id)}]),onClick:e=>G(t)},R(e.label),11,ee),W(C).browser.isMini?(m(),v("span",{key:0,class:"dept-tree__node-icon",onClick:a=>le(a,t,e)},[f(a,null,{default:g((()=>[f(W(A))])),_:1})],8,te)):x("",!0)])]})),_:1},8,["data","draggable"])),[[d,N.value]])])),_:1})],40,X),f(r,{ref_key:"Form",ref:q},null,512)])}}}),[["__scopeId","data-v-87c6d1b5"]]),ne=e=>(j("data-v-65e2f515"),e=e(),C(),e),se={class:"flex flex-wrap justify-around space-x-4",style:{display:"flex"}},oe={class:"block",style:{"margin-right":"20px"}},ie=ne((()=>y("div",{class:"text-center font-bold mb-3",style:{"margin-bottom":"2em","font-weight":"bold","text-align":"center"}}," 正面 ",-1))),re={class:"block"},de=ne((()=>y("div",{class:"text-center font-bold mb-3",style:{"margin-bottom":"2em","font-weight":"bold","text-align":"center"}}," 背面 ",-1))),pe={style:{display:"flex","justify-content":"center","margin-top":"25px"}},ue=d({name:"sys-user"}),ce=q(d({...ue,setup(e){const{service:a,refs:l,setRefs:n}=r(),{dict:i}=s(),d=i.get("identityStatus"),p=z({dept:{},ids:[]}),u=I((()=>{var e;return`成員列表（${(null==(e=p.dept)?void 0:e.name)||""}）`})),b=t.exports.useCrud({service:a.base.sys.user}),j=t.exports.useTable({columns:[{type:"selection",width:60},{prop:"name",label:"姓名",minWidth:120},{prop:"username",label:"用戶名",minWidth:150},{prop:"phone",label:"手機號碼",minWidth:120},{prop:"departmentName",label:"部門",minWidth:150},{prop:"roleName",label:"角色",headerAlign:"center",minWidth:100},{prop:"status",label:"狀態",minWidth:100,dict:[{label:"正常",value:1,type:"success"},{label:"停權",value:"danger",type:"danger"}]},{prop:"emailStatus",label:"信箱驗證",minWidth:100,dict:i.get("emailStatus")},{prop:"identityStatus",label:"身份驗證",minWidth:100,dict:i.get("identityStatus")},{prop:"remark",label:"備註",minWidth:150},{prop:"createTime",label:"創建時間",sortable:"custom",minWidth:160},{type:"op",buttons:["slot-btn","edit","delete"],width:240}]}),C=t.exports.useUpsert({dialog:{width:"800px"},items:[{prop:"avatar",label:"頭像",component:{name:"cl-upload",props:{text:"選擇頭像"}}},{prop:"firstName",label:"姓氏",span:12,required:!0,component:{name:"el-input"}},{prop:"lastName",label:"名字",required:!0,span:12,component:{name:"el-input"}},{prop:"username",label:"用戶名",required:!0,span:12,component:{name:"el-input"}},()=>{var e;return{prop:"password",label:"密碼",span:12,required:"add"==(null==(e=C.value)?void 0:e.mode),component:{name:"el-input",props:{type:"password"}},rules:[{min:8,max:16,message:"密碼長度在 8 到 16 個字符"}]}},{prop:"gender",label:"性別",value:1,component:{name:"el-radio-group",options:[{label:"男",value:1},{label:"女",value:0}]}},{prop:"roleIdList",label:"角色",value:[],required:!0,component:{name:"el-select",options:[],props:{multiple:!0,"multiple-limit":3}}},{prop:"phone",label:"手機號碼",span:12,component:{name:"el-input"}},{prop:"email",label:"郵箱",span:12,component:{name:"el-input"}},{prop:"intro",label:"簡介",component:{name:"cl-editor-wang"}},{prop:"remark",label:"備註",component:{name:"el-input",props:{type:"textarea",rows:4}}},{prop:"emailStatus",label:"信箱驗證",component:{name:"el-select",options:i.get("emailStatus")}},{prop:"identityStatus",label:"身份驗證",component:{name:"el-select",options:i.get("identityStatus")}},{prop:"status",label:"狀態",value:1,component:{name:"el-select",options:[{label:"正常",value:1},{label:"停權",value:0}]}}],onSubmit(e,{next:t}){var a;t({...e,departmentId:null==(a=p.dept)?void 0:a.id})},async onOpen(){var e;const t=await a.base.sys.role.list();null==(e=C.value)||e.setOptions("roleIdList",t.map((e=>({label:e.name||"",value:e.id}))))}});function q(e){p.ids=e.map((e=>e.id))}function M({item:e,ids:t}){var a,l;p.dept=e,a={page:1,departmentIds:t},null==(l=b.value)||l.refresh(a)}function T(e){var t;null==(t=b.value)||t.rowAppend({departmentId:e.id})}async function U(e){let t=[];t=e?[e.id]:p.ids,l.value.deptMove.open(t)}const $=V(!1),A=V({positive:"",negative:""}),B=V(""),F=V(null),E=V(null),L=async()=>{await a.base.sys.user.update({id:F.value,identityStatus:22}),E.value.identityStatus=22,o.success("修改成功")};return(e,t)=>{const l=c("cl-refresh-btn"),s=c("cl-add-btn"),i=c("cl-multi-delete-btn"),r=c("el-button"),I=c("cl-flex1"),V=c("cl-search-key"),z=c("el-row"),K=c("el-tag"),O=c("cl-table"),G=c("cl-pagination"),Q=c("cl-upsert"),Y=c("cl-crud"),D=c("el-image"),H=c("cl-dialog"),P=c("cl-view-group"),X=h("permission");return m(),w(P,{title:W(u)},{left:g((()=>[f(le,{onRowClick:M,onUserAdd:T})])),right:g((()=>[f(Y,{ref_key:"Crud",ref:b},{default:g((()=>[f(z,null,{default:g((()=>[f(l),f(s),f(i),k((m(),w(r,{type:"success",disabled:0==p.ids.length,onClick:t[0]||(t[0]=e=>U())},{default:g((()=>[_("轉移")])),_:1},8,["disabled"])),[[X,W(a).base.sys.user.permission.move]]),f(I),f(V)])),_:1}),f(z,null,{default:g((()=>[f(O,{ref_key:"Table",ref:j,"default-sort":{prop:"createTime",order:"descending"},onSelectionChange:q},{"column-identityStatus":g((({scope:e})=>{var t;return[f(r,{"disable-transitions":"",size:"small",effect:"dark",style:{margin:"2px"},type:null==(t=W(d).find((t=>t.value===e.row.identityStatus)))?void 0:t.type,onClick:t=>(async e=>{E.value=e,B.value=`${e.name} - 身份驗證`,F.value=e.id;const t=await a.base.sys.user.getIdentity({userId:e.id});A.value=t,$.value=!0})(e.row)},{default:g((()=>{var t;return[_(R(null==(t=W(d).find((t=>t.value===e.row.identityStatus)))?void 0:t.label),1)]})),_:2},1032,["type","onClick"])]})),"column-roleName":g((({scope:e})=>[e.row.roleName?(m(!0),v(N,{key:0},S(e.row.roleName.split(","),((e,t)=>(m(),w(K,{key:t,"disable-transitions":"",size:"small",effect:"dark",style:{margin:"2px"}},{default:g((()=>[_(R(e),1)])),_:2},1024)))),128)):x("",!0)])),"slot-btn":g((({scope:e})=>[k((m(),w(r,{text:"",bg:"",onClick:t=>U(e.row)},{default:g((()=>[_("轉移")])),_:2},1032,["onClick"])),[[X,W(a).base.sys.user.permission.move]])])),_:1},512)])),_:1}),f(z,null,{default:g((()=>[f(I),f(G)])),_:1}),f(Q,{ref_key:"Upsert",ref:C},null,512),f(J,{ref:W(n)("deptMove")},null,512)])),_:1},512),f(H,{title:B.value,width:"600px",height:"100%",modelValue:$.value,"onUpdate:modelValue":t[3]||(t[3]=e=>$.value=e)},{default:g((()=>{var e,l;return[y("div",se,[y("div",oe,[ie,f(D,{style:{"max-width":"600px"},src:null==(e=A.value)?void 0:e.positive,fit:"contain"},null,8,["src"])]),y("div",re,[de,f(D,{style:{"max-width":"600px"},src:null==(l=A.value)?void 0:l.negative,fit:"contain"},null,8,["src"])])]),y("div",pe,[f(r,{onClick:t[1]||(t[1]=e=>(async()=>{await a.base.sys.user.update({id:F.value,identityStatus:23}),E.value.identityStatus=23,o.success("修改成功")})()),type:"success"},{default:g((()=>[_("同意")])),_:1}),f(r,{onClick:L,type:"danger"},{default:g((()=>[_("駁回")])),_:1}),f(r,{onClick:t[2]||(t[2]=e=>$.value=!1)},{default:g((()=>[_("取消")])),_:1})])]})),_:1},8,["title","modelValue"])])),_:1},8,["title"])}}}),[["__scopeId","data-v-65e2f515"]]);export{ce as default};
